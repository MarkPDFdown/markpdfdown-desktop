name: LLM PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull request number to review'
        required: true
        type: number

concurrency:
  group: llm-review-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  llm-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # This step uses the Anthropic Messages API.
      # Secrets required: APIBase (Anthropic API base URL), APIKey, ModelId
      - name: Generate LLM review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_BASE: ${{ secrets.ANTHROPIC_BASE_URL }}
          API_KEY: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          MODEL_ID: ${{ secrets.ANTHROPIC_MODEL }}
          PR_NUMBER: ${{ github.event.pull_request.number || github.event.inputs.pr_number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          IFS=$'\n\t'

          pr_json=$(curl -sf \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER") || {
              echo "::error::Failed to fetch PR metadata"
              exit 1
            }

          pr_title=$(printf "%s" "$pr_json" | jq -r '.title // ""')
          pr_body=$(printf "%s" "$pr_json" | jq -r '.body // ""')

          pr_diff=$(curl -sf \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3.diff" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER") || {
              echo "::error::Failed to fetch PR diff"
              exit 1
            }

          max_diff_chars=60000
          pr_diff_trimmed=$(printf "%s" "$pr_diff" | head -c $max_diff_chars)

          system_prompt=$(cat <<'EOF'
          You are a senior software engineer performing a pull request code review.
          Focus on: Correctness, Security, Performance, Maintainability, Readability, Testing.
          Output must be in English.

          Use this exact format and omit empty sections:
          # Summary
          <1-2 sentences overall assessment>

          # Critical
          - [file:line] Title: explanation...

          # Important
          - [file:line] Title: explanation...

          # Suggestion
          - [file:line] Title: explanation...

          # Praise
          - [file:line] Title: explanation...
          EOF
          )

          request_body=$(jq -n \
            --arg model "$MODEL_ID" \
            --arg system "$system_prompt" \
            --arg title "$pr_title" \
            --arg body "$pr_body" \
            --arg diff "$pr_diff_trimmed" \
            '{
              model: $model,
              max_tokens: 4096,
              system: $system,
              messages: [
                { role: "user", content: ("Review the following pull request.\n\n## Title\n" + $title + "\n\n## Description\n" + $body + "\n\n## Diff\n" + $diff) }
              ]
            }')

          llm_response=$(curl -sf \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -H "anthropic-version: 2023-06-01" \
            "$API_BASE/v1/messages" \
            -d "$request_body") || {
              echo "::error::LLM API request failed"
              exit 1
            }

          review_text=$(printf "%s" "$llm_response" | jq -r '.content[0].text // ""')

          if [ -z "$review_text" ]; then
            echo "::error::LLM response missing content. Raw response:"
            printf "%s" "$llm_response" | jq .
            exit 1
          fi

          review_payload=$(jq -n --arg body "$review_text" '{body: $body, event: "COMMENT"}')

          curl -sf \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews" \
            -d "$review_payload" >/dev/null || {
              echo "::error::Failed to post PR review"
              exit 1
            }
